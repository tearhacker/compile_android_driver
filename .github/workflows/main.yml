name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., hello.ko)'
        required: true
        default: 'hello.ko'
      target_arch:
        description: 'Target Architecture (aarch64, x86_64, etc.)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Free up disk space
        run: |
          echo "=== 清理磁盘空间 ==="
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          sudo docker image prune --all --force || true
          df -h
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          cp ./helloWorld/*.c ./helloWorld/Makefile kerneldriver/
          ls -la kerneldriver/
          
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync
      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list
        if: ${{ github.event.inputs.android_version > 13 }}
        run: |
          cd android-kernel
          
          # 对于 Android 14+ 使用 obj-y 内置编译，不需要添加到模块列表
          # 模块代码会直接编译进内核镜像
          echo "Android ${{ github.event.inputs.android_version }} 使用 obj-y 内置编译模式"
          echo "模块将直接编译进内核，无需添加到 GKI 模块列表"
          
          # 验证 Makefile 使用 obj-y
          cat common/drivers/kerneldriver/Makefile
          
      - name: Prepare module list for legacy builds
        if: ${{ github.event.inputs.android_version <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_aarch64_modules
      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3
      - name: Fix missing kprobe symbols for Android 13
        if: ${{ github.event.inputs.android_version == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel module
        run: |
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
            OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "=== Using Bazel build for Android ${{ github.event.inputs.android_version }} ==="
            # 使用 obj-y 内置编译，不生成 .ko，直接编译进内核镜像
            # 只构建内核本体，不用 _dist（它会检查 .ko 文件存在性）
            tools/bazel build //common:kernel_${{ github.event.inputs.target_arch }}
            
            # 手动收集构建产物
            OUTPUT_PATH="bazel-bin/common/kernel_${{ github.event.inputs.target_arch }}"
            
            echo "=== 构建产物位置 ==="
            ls -la $OUTPUT_PATH/ || true
            find bazel-bin -name "Image*" -o -name "vmlinux" -o -name "*.ko" 2>/dev/null | head -20 || true
          fi
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
      
      - name: Prepare kernel build environment package
        run: |
          cd android-kernel
          
          echo "=== 清理 .git 目录节省空间 ==="
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "=== 清理编译中间文件 ==="
          find . -name "*.o" -delete 2>/dev/null || true
          find . -name "*.cmd" -delete 2>/dev/null || true
          find . -name "*.d" -delete 2>/dev/null || true
          
          echo "=== 收集编译产物到 common 目录 ==="
          mkdir -p common/out
          find bazel-bin -name "Image" -exec cp {} common/out/ \; 2>/dev/null || true
          find bazel-bin -name "Image.lz4" -exec cp {} common/out/ \; 2>/dev/null || true
          find bazel-bin -name "vmlinux" -exec cp {} common/out/ \; 2>/dev/null || true
          find bazel-bin -name "Module.symvers" -exec cp {} common/out/ \; 2>/dev/null || true
          find bazel-bin -name "System.map" -exec cp {} common/out/ \; 2>/dev/null || true
          find bazel-bin -name ".config" -exec cp {} common/out/ \; 2>/dev/null || true
          
          echo "=== 检查大小 ==="
          du -sh common/
          
          echo "=== 打包完整源码 ==="
          cd $GITHUB_WORKSPACE/android-kernel
          ARCHIVE_NAME="kernel-source-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}"
          
          # 分卷压缩，每卷 1.9GB（Release 限制 2GB）
          tar -cvf - common | split -b 1900M - "$GITHUB_WORKSPACE/${ARCHIVE_NAME}.tar.part"
          
          # 如果只有一个分卷，重命名为 .tar.gz
          cd $GITHUB_WORKSPACE
          PART_COUNT=$(ls -1 ${ARCHIVE_NAME}.tar.part* 2>/dev/null | wc -l)
          if [ "$PART_COUNT" -eq 1 ]; then
            mv ${ARCHIVE_NAME}.tar.partaa ${ARCHIVE_NAME}.tar
            gzip ${ARCHIVE_NAME}.tar
            echo "SINGLE_FILE=true" >> $GITHUB_ENV
          else
            echo "SINGLE_FILE=false" >> $GITHUB_ENV
          fi
          
          ls -lh ${ARCHIVE_NAME}*
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-${{ github.run_number }}
          name: "GKI Kernel ${{ github.event.inputs.target_arch }} Android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}"
          body: |
            ## GKI 内核完整源码 + 编译产物
            
            - Android 版本: ${{ github.event.inputs.android_version }}
            - 内核版本: ${{ github.event.inputs.kernel_version }}
            - 架构: ${{ github.event.inputs.target_arch }}
            - 驱动已内置编译进 Image
            
            ### 下载后解压
            ```bash
            # 单文件
            tar -xzvf kernel-source-*.tar.gz
            
            # 分卷文件
            cat kernel-source-*.tar.part* | tar -xvf -
            ```
            
            ### 编译外部模块
            ```bash
            export KDIR=/path/to/common
            make -C $KDIR M=$(pwd) ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules
            ```
          files: |
            ${{ env.ARCHIVE_NAME }}*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # artifact 上传已移除，改用 Release 上传完整源码
