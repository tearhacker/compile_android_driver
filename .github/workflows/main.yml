name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (e.g., 13, 14, 15)'
        required: true
        default: '14'
      kernel_version:
        description: 'Kernel Version (e.g., 5.15, 6.1, 6.6)'
        required: true
        default: '6.1'
      driver_name:
        description: 'Driver Module Name (e.g., hello.ko)'
        required: true
        default: 'hello.ko'
      target_arch:
        description: 'Target Architecture'
        required: true
        default: 'aarch64'

env:
  ANDROID_VERSION: ${{ github.event.inputs.android_version }}
  KERNEL_VERSION: ${{ github.event.inputs.kernel_version }}
  DRIVER_NAME: ${{ github.event.inputs.driver_name }}
  TARGET_ARCH: ${{ github.event.inputs.target_arch }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "=== 清理磁盘空间 ==="
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          sudo docker image prune --all --force || true
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc \
            python-is-python3 git-lfs cpio kmod

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Sync Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${ANDROID_VERSION}-${KERNEL_VERSION}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: Prepare driver source
        run: |
          mkdir -p android-kernel/external_modules/hello
          cp ./helloWorld/Hello.c android-kernel/external_modules/hello/
          
          # 创建独立模块 Makefile (obj-m 编译为 .ko)
          echo 'obj-m += hello.o' > android-kernel/external_modules/hello/Makefile
          echo 'hello-objs := Hello.o' >> android-kernel/external_modules/hello/Makefile
          
          echo "=== Makefile 内容 ==="
          cat android-kernel/external_modules/hello/Makefile
          ls -la android-kernel/external_modules/hello/

      - name: Build Kernel (Android 13 and below - build.sh)
        if: ${{ github.event.inputs.android_version == '12' || github.event.inputs.android_version == '13' }}
        run: |
          cd android-kernel
          
          # 添加 kprobe 符号到白名单
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${TARGET_ARCH} || \
            echo "  $symbol" >> common/android/abi_gki_${TARGET_ARCH}
          done
          
          # 编译内核
          BUILD_CONFIG=common/build.config.gki.${TARGET_ARCH} \
            LTO=thin \
            SKIP_ABI_CHECKS=1 \
            build/build.sh -j$(nproc)
          
          # 设置输出路径
          echo "KERNEL_OUT=$(pwd)/out/android${ANDROID_VERSION}-${KERNEL_VERSION}/dist" >> $GITHUB_ENV

      - name: Build Kernel (Android 14+ - Bazel)
        if: ${{ github.event.inputs.android_version != '12' && github.event.inputs.android_version != '13' }}
        run: |
          cd android-kernel
          
          echo "=== 使用 Bazel 构建 Android ${ANDROID_VERSION} 内核 ==="
          
          # 构建内核和模块开发所需文件
          tools/bazel run //common:kernel_${TARGET_ARCH}_dist -- --dist_dir=dist
          
          echo "=== 构建产物 ==="
          ls -la dist/ || true
          
          echo "KERNEL_OUT=$(pwd)/dist" >> $GITHUB_ENV

      - name: Build external module
        run: |
          cd android-kernel
          
          echo "=== 编译外部模块 ==="
          
          # 查找交叉编译工具链
          CLANG_BIN=$(find prebuilts -path "*/linux-x86/clang-*/bin" -type d 2>/dev/null | head -1)
          GCC_BIN=$(find prebuilts -path "*aarch64*linux-android*/bin" -type d 2>/dev/null | head -1)
          
          if [ -z "$CLANG_BIN" ]; then
            echo "未找到预置 clang，安装系统工具链"
            sudo apt-get install -y clang lld llvm
            CLANG_BIN="/usr/bin"
          fi
          
          echo "CLANG_BIN: $CLANG_BIN"
          echo "GCC_BIN: $GCC_BIN"
          
          export PATH="$CLANG_BIN:$GCC_BIN:$PATH"
          
          # 查找 .config 和 Module.symvers
          KERNEL_OUT=""
          if [ -d "dist" ]; then
            KERNEL_OUT="$(pwd)/dist"
          else
            KERNEL_OUT="$(find out bazel-bin -name "dist" -type d 2>/dev/null | head -1)"
          fi
          
          echo "KERNEL_OUT: $KERNEL_OUT"
          
          # 准备内核源码目录用于模块编译
          KERNEL_SRC="$(pwd)/common"
          MODULE_DIR="$(pwd)/external_modules/hello"
          
          # 复制 .config 和 Module.symvers 到源码目录
          if [ -n "$KERNEL_OUT" ] && [ -d "$KERNEL_OUT" ]; then
            echo "=== 复制构建配置到源码目录 ==="
            cp "$KERNEL_OUT/.config" "$KERNEL_SRC/" 2>/dev/null || true
            cp "$KERNEL_OUT/Module.symvers" "$KERNEL_SRC/" 2>/dev/null || true
            
            # 复制生成的头文件
            if [ -d "$KERNEL_OUT/include" ]; then
              cp -r "$KERNEL_OUT/include/config" "$KERNEL_SRC/include/" 2>/dev/null || true
              cp -r "$KERNEL_OUT/include/generated" "$KERNEL_SRC/include/" 2>/dev/null || true
            fi
          fi
          
          # 确保有 .config
          if [ ! -f "$KERNEL_SRC/.config" ]; then
            echo "=== 生成默认 GKI 配置 ==="
            make -C "$KERNEL_SRC" ARCH=arm64 gki_defconfig || true
          fi
          
          # 准备内核构建环境
          echo "=== 准备内核构建环境 ==="
          make -C "$KERNEL_SRC" ARCH=arm64 \
            CC=clang LD=ld.lld LLVM=1 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            modules_prepare
          
          # 编译外部模块
          echo "=== 编译外部模块 ==="
          make -C "$KERNEL_SRC" M="$MODULE_DIR" \
            ARCH=arm64 \
            CC=clang LD=ld.lld LLVM=1 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            modules
          
          echo "=== 查找编译产物 ==="
          find . -name "*.ko" -type f 2>/dev/null
          
          # 复制 .ko 到输出目录
          mkdir -p $GITHUB_WORKSPACE/output
          find . -name "*.ko" -exec cp {} $GITHUB_WORKSPACE/output/ \; 2>/dev/null || true
          
          # 检查是否成功
          if ls $GITHUB_WORKSPACE/output/*.ko 1>/dev/null 2>&1; then
            echo "=== 模块编译成功 ==="
            for ko in $GITHUB_WORKSPACE/output/*.ko; do
              echo "--- $ko ---"
              file "$ko"
              
              echo "--- 模块依赖的符号 ---"
              ${CLANG_BIN}/llvm-nm "$ko" 2>/dev/null | grep " U " || nm "$ko" | grep " U " || true
              
              echo "--- vermagic ---"
              strings "$ko" | grep vermagic || true
            done
            
            # 验证符号是否在 ABI 白名单中
            echo "=== 验证符号兼容性 ==="
            ABI_FILE="$KERNEL_SRC/android/abi_gki_aarch64"
            if [ -f "$ABI_FILE" ]; then
              for ko in $GITHUB_WORKSPACE/output/*.ko; do
                echo "检查 $ko 的符号..."
                UNDEFINED=$(${CLANG_BIN}/llvm-nm "$ko" 2>/dev/null | grep " U " | awk '{print $2}' || nm "$ko" | grep " U " | awk '{print $2}')
                MISSING=""
                for sym in $UNDEFINED; do
                  # 跳过编译器内置符号
                  case "$sym" in
                    __stack_chk_*|__aeabi_*|__gnu_*|_GLOBAL_*) continue ;;
                  esac
                  if ! grep -q "^  $sym$" "$ABI_FILE" 2>/dev/null; then
                    # 基础内核符号通常都导出，只警告非基础符号
                    echo "  符号 $sym 不在 ABI 白名单中 (可能是基础符号，通常没问题)"
                  fi
                done
              done
            fi
          else
            echo "::error::模块编译失败"
            exit 1
          fi

      - name: Collect build artifacts
        run: |
          cd android-kernel
          
          echo "=== 收集编译产物 ==="
          mkdir -p $GITHUB_WORKSPACE/output/kernel
          
          # 复制内核镜像
          for file in Image Image.lz4 Image.gz vmlinux System.map .config Module.symvers; do
            find . -name "$file" -type f -exec cp {} $GITHUB_WORKSPACE/output/kernel/ \; 2>/dev/null || true
          done
          
          ls -la $GITHUB_WORKSPACE/output/
          ls -la $GITHUB_WORKSPACE/output/kernel/

      - name: Package kernel source
        run: |
          cd android-kernel
          
          echo "=== 清理不必要文件 ==="
          find . -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.o" -delete 2>/dev/null || true
          find . -name "*.cmd" -delete 2>/dev/null || true
          
          echo "=== 打包内核源码 ==="
          ARCHIVE_NAME="kernel-source-android${ANDROID_VERSION}-${KERNEL_VERSION}-${TARGET_ARCH}"
          
          # 只打包 common 目录（主要源码）
          tar -cvf - common | gzip -1 > $GITHUB_WORKSPACE/output/${ARCHIVE_NAME}.tar.gz
          
          # 检查大小，如果超过 2GB 则分卷
          SIZE=$(stat -c%s "$GITHUB_WORKSPACE/output/${ARCHIVE_NAME}.tar.gz")
          if [ $SIZE -gt 2000000000 ]; then
            echo "文件过大，进行分卷..."
            rm $GITHUB_WORKSPACE/output/${ARCHIVE_NAME}.tar.gz
            tar -cvf - common | split -b 1900M - $GITHUB_WORKSPACE/output/${ARCHIVE_NAME}.tar.part
          fi
          
          ls -lh $GITHUB_WORKSPACE/output/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }}-${{ github.run_number }}
          name: "GKI Kernel Android${{ env.ANDROID_VERSION }}-${{ env.KERNEL_VERSION }} (${{ env.TARGET_ARCH }})"
          body: |
            ## GKI 内核编译产物
            
            | 项目 | 值 |
            |------|-----|
            | Android 版本 | ${{ env.ANDROID_VERSION }} |
            | 内核版本 | ${{ env.KERNEL_VERSION }} |
            | 架构 | ${{ env.TARGET_ARCH }} |
            | 驱动模块 | ${{ env.DRIVER_NAME }} |
            
            ### 包含文件
            - `hello.ko` - 编译好的内核模块
            - `kernel/` - 内核镜像 (Image, vmlinux, Module.symvers 等)
            - `kernel-source-*.tar.gz` - 完整内核源码
            
            ### 加载模块
            ```bash
            # 推送到设备
            adb push hello.ko /data/local/tmp/
            
            # 加载模块 (需要 root)
            adb shell su -c "insmod /data/local/tmp/hello.ko"
            
            # 查看日志
            adb shell dmesg | grep -i hello
            
            # 卸载模块
            adb shell su -c "rmmod hello"
            ```
            
            ### 使用源码编译其他模块
            ```bash
            # 解压源码
            tar -xzf kernel-source-*.tar.gz
            
            # 编译你的模块
            make -C common M=/path/to/your/module \
              ARCH=arm64 \
              CROSS_COMPILE=aarch64-linux-gnu- \
              LLVM=1 \
              modules
            ```
          files: |
            output/*.ko
            output/kernel/*
            output/*.tar.gz
            output/*.tar.part*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
