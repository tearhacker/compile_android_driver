name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., hello.ko)'
        required: true
        default: 'hello.ko'
      target_arch:
        description: 'Target Architecture (aarch64, x86_64, etc.)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Free up disk space
        run: |
          echo "=== 清理磁盘空间 ==="
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          sudo docker image prune --all --force || true
          df -h
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          cp ./helloWorld/*.c ./helloWorld/Makefile kerneldriver/
          ls -la kerneldriver/
          
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync
      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list
        if: ${{ github.event.inputs.android_version > 13 }}
        run: |
          cd android-kernel
          
          # 对于 Android 14+ 使用 obj-y 内置编译，不需要添加到模块列表
          # 模块代码会直接编译进内核镜像
          echo "Android ${{ github.event.inputs.android_version }} 使用 obj-y 内置编译模式"
          echo "模块将直接编译进内核，无需添加到 GKI 模块列表"
          
          # 验证 Makefile 使用 obj-y
          cat common/drivers/kerneldriver/Makefile
          
      - name: Prepare module list for legacy builds
        if: ${{ github.event.inputs.android_version <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_aarch64_modules
      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3
      - name: Fix missing kprobe symbols for Android 13
        if: ${{ github.event.inputs.android_version == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel module
        run: |
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
            OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
            # 使用 kernel_aarch64_dist 但不检查特定 .ko 文件
            # 因为我们使用 obj-y 内置编译，模块代码直接编译进内核
            tools/bazel build //common:kernel_${{ github.event.inputs.target_arch }}
            OUTPUT_PATH="bazel-bin/common/kernel_${{ github.event.inputs.target_arch }}"
          fi
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
      
      - name: Prepare kernel build environment package
        run: |
          cd android-kernel
          mkdir -p $GITHUB_WORKSPACE/kernel-dev-package
          
          echo "=== 复制编译产物 ==="
          cp -r ${{ env.OUTPUT_PATH }}/* $GITHUB_WORKSPACE/kernel-dev-package/
          
          echo "=== 复制内核头文件 ==="
          mkdir -p $GITHUB_WORKSPACE/kernel-dev-package/kernel-headers
          cp -r common/include $GITHUB_WORKSPACE/kernel-dev-package/kernel-headers/
          cp -r common/arch/${{ github.event.inputs.target_arch == 'aarch64' && 'arm64' || github.event.inputs.target_arch }}/include $GITHUB_WORKSPACE/kernel-dev-package/kernel-headers/arch-include || true
          
          echo "=== 复制内核符号表 ==="
          find . -name "Module.symvers" -exec cp {} $GITHUB_WORKSPACE/kernel-dev-package/ \; 2>/dev/null || true
          find . -name "vmlinux" -exec cp {} $GITHUB_WORKSPACE/kernel-dev-package/ \; 2>/dev/null || true
          find . -name "System.map" -exec cp {} $GITHUB_WORKSPACE/kernel-dev-package/ \; 2>/dev/null || true
          
          echo "=== 复制内核配置 ==="
          find . -name ".config" -path "*/out/*" -exec cp {} $GITHUB_WORKSPACE/kernel-dev-package/ \; 2>/dev/null || true
          
          echo "=== 清理中间文件 ==="
          cd $GITHUB_WORKSPACE/kernel-dev-package
          find . -name "*.o" -delete
          find . -name "*.cmd" -delete
          find . -name "*.d" -delete
          
          echo "=== 生成模块编译说明 ==="
          cat > README_BUILD_MODULE.md << 'EOF'
          # 内核模块编译环境
          
          ## 包含内容
          - `*.ko` - 编译好的内核模块
          - `Image*` - 内核镜像
          - `vmlinux` - 未压缩内核 (用于调试)
          - `Module.symvers` - 内核符号表 (编译外部模块必需)
          - `System.map` - 内核符号地址映射
          - `.config` - 内核配置
          - `kernel-headers/` - 内核头文件
          
          ## 本地编译其他模块
          ```bash
          export KERNEL_DIR=/path/to/kernel-dev-package
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          make -C $KERNEL_DIR M=$(pwd) modules
          ```
          EOF
          
          echo "=== 压缩打包 ==="
          cd $GITHUB_WORKSPACE
          tar -czvf kernel-dev-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}.tar.gz kernel-dev-package
          ls -lh kernel-dev-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}.tar.gz

      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-dev-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          path: kernel-dev-${{ github.event.inputs.target_arch }}-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}.tar.gz
