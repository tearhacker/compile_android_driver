name: Android Kernel Module Builder (Minimal)
#泪心提交
# 极简版：只下载预编译的内核头文件，编译单个模块
# 适合 GitHub 免费用户，编译时间约 10-30 分钟

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: '6.1'
        type: choice
        options:
          - '5.15'
          - '6.1'
          - '6.6'
      driver_name:
        description: 'Driver Module Name (without .ko)'
        required: true
        default: 'kernel_hack'

jobs:
  build-module:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            flex \
            bison \
            libssl-dev \
            libelf-dev \
            bc \
            python3 \
            python-is-python3 \
            git \
            curl \
            wget \
            kmod \
            cpio \
            zstd \
            llvm \
            clang \
            lld

      - name: Setup Android NDK (for cross-compilation)
        run: |
          # 下载 Android NDK
          wget -q https://dl.google.com/android/repository/android-ndk-r26c-linux.zip
          unzip -q android-ndk-r26c-linux.zip
          export NDK_PATH=$PWD/android-ndk-r26c
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Download prebuilt kernel headers
        run: |
          mkdir -p kernel-headers
          cd kernel-headers
          
          # 从 Google 的 GKI 预编译中获取内核头文件
          # 这比编译整个内核快得多
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          
          case $KERNEL_VER in
            "5.15")
              BRANCH="android13-5.15"
              ;;
            "6.1")
              BRANCH="android14-6.1"
              ;;
            "6.6")
              BRANCH="android15-6.6"
              ;;
          esac
          
          echo "Downloading kernel headers for $BRANCH..."
          
          # 浅克隆只获取头文件
          git clone --depth=1 --single-branch \
            -b common-$BRANCH \
            https://android.googlesource.com/kernel/common \
            kernel-source
          
          echo "=== Kernel source downloaded ==="
          ls -la kernel-source/

      - name: Prepare driver source
        run: |
          mkdir -p driver-src
          
          # 复制驱动源码
          if [ -d "./code" ]; then
            cp ./code/*.c ./code/*.h driver-src/ 2>/dev/null || true
          fi
          
          # 如果没有源码，创建示例
          if [ ! -f "driver-src/${{ github.event.inputs.driver_name }}.c" ]; then
            echo "Creating sample driver..."
            cat > driver-src/${{ github.event.inputs.driver_name }}.c << 'EOF'
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>

MODULE_LICENSE("GPL");
MODULE_AUTHOR("Builder");
MODULE_DESCRIPTION("Sample Kernel Module");

static int __init sample_init(void)
{
    printk(KERN_INFO "Module loaded\n");
    return 0;
}

static void __exit sample_exit(void)
{
    printk(KERN_INFO "Module unloaded\n");
}

module_init(sample_init);
module_exit(sample_exit);
EOF
          fi
          
          # 创建 Makefile
          cat > driver-src/Makefile << EOF
obj-m += ${{ github.event.inputs.driver_name }}.o

KERNEL_SRC ?= ../kernel-headers/kernel-source

all:
	\$(MAKE) -C \$(KERNEL_SRC) M=\$(PWD) modules ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1

clean:
	\$(MAKE) -C \$(KERNEL_SRC) M=\$(PWD) clean
EOF
          
          echo "=== Driver source ==="
          ls -la driver-src/

      - name: Configure kernel for module build
        run: |
          cd kernel-headers/kernel-source
          
          # 使用 GKI defconfig
          make ARCH=arm64 LLVM=1 gki_defconfig || make ARCH=arm64 LLVM=1 defconfig
          
          # 启用模块支持
          scripts/config --enable CONFIG_MODULES
          scripts/config --enable CONFIG_MODULE_UNLOAD
          
          # 准备内核头文件
          make ARCH=arm64 LLVM=1 modules_prepare -j$(nproc)
          
          echo "=== Kernel configured ==="

      - name: Build kernel module
        run: |
          cd driver-src
          
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export LLVM=1
          
          make KERNEL_SRC=../kernel-headers/kernel-source -j$(nproc)
          
          echo "=== Build result ==="
          ls -la *.ko 2>/dev/null || echo "No .ko files found"

      - name: Collect artifacts
        run: |
          mkdir -p output
          find . -name "*.ko" -type f -exec cp {} output/ \;
          
          echo "=== Output files ==="
          ls -la output/
          
          # 显示模块信息
          for ko in output/*.ko; do
            if [ -f "$ko" ]; then
              echo "=== Module info: $ko ==="
              file "$ko"
              modinfo "$ko" 2>/dev/null || true
            fi
          done

      - name: Upload kernel module
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.driver_name }}-kernel${{ github.event.inputs.kernel_version }}-arm64
          path: output/*.ko
          retention-days: 30
          if-no-files-found: warn
